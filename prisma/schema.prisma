generator client {
  provider            = "prisma-client"
  output              = "../src/generated/prisma"
  moduleFormat        = "cjs"
  importFileExtension = ""
}

datasource db {
  provider = "postgresql"
}


enum SeatStatus {
  AVAILABLE
  RESERVED
  SOLD
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  EXPIRED
  CANCELLED
}

model User {
  id           String        @id @default(uuid()) @db.Uuid
  name         String
  email        String        @unique
  passwordHash String        @map("password_hash")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  reservations Reservation[]
  sales        Sale[]

  @@map("users")
}

model Session {
  id                 String   @id @default(uuid()) @db.Uuid
  movieTitle         String   @map("movie_title")
  room               String
  startsAt           DateTime @map("starts_at")
  ticketPriceInCents Int      @map("ticket_price_in_cents")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  seats        Seat[]
  reservations Reservation[]

  @@unique([room, startsAt])
  @@map("sessions")
}

model Seat {
  id        String     @id @default(uuid()) @db.Uuid
  sessionId String     @map("session_id") @db.Uuid
  label     String
  status    SeatStatus @default(AVAILABLE)
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  session          Session           @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  reservationSeats ReservationSeat[]

  @@unique([sessionId, label])
  @@index([sessionId, status])
  @@map("seats")
}

model Reservation {
  id              String            @id @default(uuid()) @db.Uuid
  userId          String            @map("user_id") @db.Uuid
  sessionId       String            @map("session_id") @db.Uuid
  status          ReservationStatus @default(PENDING)
  expiresAt       DateTime          @map("expires_at")
  idempotencyKey  String?           @unique @map("idempotency_key")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  user             User              @relation(fields: [userId], references: [id])
  session          Session           @relation(fields: [sessionId], references: [id])
  reservationSeats ReservationSeat[]
  sale             Sale?

  @@index([status, expiresAt])
  @@index([userId])
  @@map("reservations")
}

model ReservationSeat {
  reservationId String @map("reservation_id") @db.Uuid
  seatId        String   @map("seat_id") @db.Uuid
  createdAt     DateTime @default(now()) @map("created_at")

  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  seat        Seat        @relation(fields: [seatId], references: [id])

  @@id([reservationId, seatId])
  @@map("reservation_seats")
}

model Sale {
  id            String   @id @default(uuid()) @db.Uuid
  reservationId String   @unique @map("reservation_id") @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  totalInCents  Int      @map("total_in_cents")
  confirmedAt   DateTime @default(now()) @map("confirmed_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  reservation Reservation @relation(fields: [reservationId], references: [id])
  user        User        @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("sales")
}
